arazzo: 1.1.0
info:
  title: Asynchronous User Creation and Payment Workflow
  version: 1.0.0
  description: |
    This workflow checks if a user exists, creates one if necessary,
    waits for a user acknowledgment event, sends a payment request event,
    waits for confirmation, and then sends a confirmation email.

sourceDescriptions:
  - name: UserEmailOpenApi
    type: openapi
    url: ./user-email-api.openapi.yaml
  - name: AsyncAPIEventBus
    type: asyncapi
    url: ./user-payment-events.asyncapi.yaml

workflows:
  - workflowId: userPaymentFlow
    inputs:
      required: [email, productId, amount]
      type: object
      properties:
        email:
          type: string
        productId:
          type: string
        orderId:
          type: string
        amount:
          type: number

    steps:
      - stepId: GetUser
        operationId: $sourceDescriptions.UserEmailOpenApi.getUserByEmail
        parameters:
          - name: email
            in: query
            value: $inputs.email
        successCriteria:
          - condition: $statusCode == 200
        outputs:
          userId: $response.body#/id
        onFailure:
          - condition: $statusCode == 404
            type: goto
            step: CreateUser
        onSuccess:
          - condition: $statusCode == 200
            goto: SendPaymentRequest

      - stepId: CreateUser
        operationId: $sourceDescriptions.UserEmailOpenApi.createUser
        requestBody:
          contentType: application/json
          payload: |
            {
              "email": "{$inputs.email}"
            }
        successCriteria:
          - condition: $statusCode == 202
        outputs:
          userCorrelationId: $response.body#/correlationId

      - stepId: WaitForUserAck
        operationId: $sourceDescriptions.AsyncAPIEventBus.receiveUserAck
        action: receive
        correlationId: $steps.GetUser.outputs.userCorrelationId
        timeout: 10000
        successCriteria:
          - condition: $message.payload.status == "ok"
       onSuccess:
          - condition: $message.payload.status == "ok"
            goto: GetUser

      - stepId: SendPaymentRequest
        operationId: $sourceDescriptions.AsyncAPIEventBus.sendPaymentRequest
        action: send
        requestBody:
          contentType: application/json
          payload: |
            {
              "userId": "{$steps.GetUser.outputs.userId}",
              "productId": "{$inputs.productId}",
              "orderId": "{$inputs.orderId}",
              "amount": "{$inputs.amount}"
            }
        parameters:
          - name: correlationId
            in: header
            value: "{$inputs.orderId}"

      - stepId: WaitForPaymentConfirm
        operationId: $sourceDescriptions.AsyncAPIEventBus.receivePaymentConfirm
        action: receive
        correlationId: $inputs.orderId
        timeout: 15000
        successCriteria:
          - condition: $message.payload.status == "confirmed"

      - kind: openapi
        stepId: SendConfirmationEmail
        operationId: $sourceDescriptions.UserEmailOpenApi.sendEmail
        dependsOn:
          - $steps.WaitForPaymentConfirm
        requestBody:
          contentType: application/json
          payload: |
            {
              "to": "{$inputs.email}",
              "subject": "Your order #{$inputs.orderId} is confirmed!",
              "body": "Thanks for your purchase. Your payment has been received."
            }
        successCriteria:
          - condition: $statusCode == 200

    outputs:
      - status: "completed successfully"